<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Listings</title>
  <link rel="stylesheet" href="/css/singlelist.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="/js/map.js"></script>
</head>
<body>
  <% layout("/layouts/boilerplate.ejs") %>

  <!-- Main container with flex row -->
  <div class="main-row">

    <!-- Listing Card -->
    <div class="card">
      <img src="<%= singleitems.image.url %>" alt="<%= singleitems.title %>" class="card-img">
      <div class="card-body">
        <h2 class="card-title"><%= singleitems.title %></h2>
        <p class="card-desc">Owner: <%= singleitems.owner.username %></p>
        <p class="card-desc"><%= singleitems.description %></p>
        <p class="card-location">üìç <%= singleitems.location %>, <%= singleitems.country %></p>
        <p class="card-price">üí∞ &#8377;<%= singleitems.price.toLocaleString("en-IN") %></p>
        <small class="card-date">Created: <%= singleitems.created_at.toDateString() %></small>
      </div>

      <% if(currUser && currUser._id.equals(singleitems.owner._id)){ %>
        <div class="card-actions">
          <form action="<%= singleitems._id %>/edit" method="GET">
            <button >Edit</button>
          </form>
          <form action="<%= singleitems._id %>?_method=DELETE" method="POST">
            <button >Delete</button>
          </form>
        </div>
      <% } %>
    </div>

    <!-- Leave Review -->
    <div class="leavereview">
      <h4>Leave a Review</h4>
      <% if(currUser){ %>
        <form action="/listings/<%= singleitems._id %>/reviews" method="POST">
          <div>
            <label for="rating">Rating</label>
            <fieldset class="starability-slot">
              <input type="radio" id="rate1" name="review[rating]" value="1" />
              <label for="rate1">1‚òÖ</label>
              <input type="radio" id="rate2" name="review[rating]" value="2" />
              <label for="rate2">2‚òÖ</label>
              <input type="radio" id="rate3" name="review[rating]" value="3" />
              <label for="rate3">3‚òÖ</label>
              <input type="radio" id="rate4" name="review[rating]" value="4" />
              <label for="rate4">4‚òÖ</label>
              <input type="radio" id="rate5" name="review[rating]" value="5" />
              <label for="rate5">5‚òÖ</label>
            </fieldset>
          </div>
          <div>
            <label for="comment">Comment</label>
            <textarea name="review[comment]" id="comment" cols="25" rows="6" required></textarea>
          </div>
          <button type="submit">Submit</button>
        </form>
      <% } %>
    </div>

    <!-- Reviews Section -->
    <div class="reviews-section">
      <h2>All Reviews</h2>
      <div class="reviews-grid">
        <% if (singleitems && singleitems.reviews && singleitems.reviews.length) { %>
          <% for (const review of singleitems.reviews) { %>
            <article class="review-card">
              <header class="review-header">
                <div class="avatar"><%= (review.comment?.[0] || 'A').toUpperCase() %></div>
                <div class="meta">
                  <p><strong>Author:</strong> <%= review.author ? review.author.username : 'Unknown' %></p>
                  <p><%= review.comment %></p>
                  <div class="stars">
                    <span class="stars-fill"><%= '‚òÖ'.repeat(review.rating || 0) %></span>
                    <span class="stars-empty"><%= '‚òÜ'.repeat(5 - (review.rating || 0)) %></span>
                  </div>
                </div>
              </header>
              <footer class="review-footer">
                <time><%= new Date(review.createdAt).toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' }) %></time>
              </footer>
              <form action="/listings/<%= singleitems._id %>/reviews/<%= review._id %>?_method=DELETE" method="POST">
                <button>Delete Review</button>
              </form>
            </article>
          <% } %>
        <% } else { %>
          <p class="no-reviews">No reviews yet.</p>
        <% } %>
      </div>
    </div>

  </div>

  <script src="/js/script.js"></script>
</body>
</html>